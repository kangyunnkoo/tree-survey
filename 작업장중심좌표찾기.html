<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‘ì—…ì¥ ì¤‘ì‹¬ì¢Œí‘œ ì°¾ê¸° â€” ì¹´ì¹´ì˜¤ë§µ</title>

<style>
  body { font-family: 'Noto Sans KR', sans-serif; margin:0; padding:16px; background:#f3f6f9; color:#111 }
  .container { max-width:1100px; margin:0 auto; }
  header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
  h1 { font-size:1.1rem; margin:0; }
  #map { width:100%; height:72vh; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
  .controls { margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .info { background:#fff; padding:10px 12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.04); display:flex; gap:10px; align-items:center;}
  button { padding:8px 12px; border-radius:6px; border:0; cursor:pointer; background:#2563eb; color:#fff; }
  button.secondary { background:#10b981; }
  input.copybox { border:1px solid #ddd; padding:6px 8px; border-radius:6px; width:260px; }
  small.note { color:#666; display:block; margin-top:6px; }
  @media (max-width:720px) { #map { height:56vh; } .info { flex-direction:column; align-items:flex-start } }
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ“ ì£¼ì†Œ ê¸°ë°˜ ì¢Œí‘œ ì„ íƒê¸°</h1>
      <div style="margin-left:auto"><small class="note">ë ˆë²¨ 2~3 ê¶Œì¥ (ê·¼ì ‘ í™•ëŒ€)</small></div>
    </header>

    <!-- Map ë Œë” íƒ€ê²Ÿ -->
    <div id="map"></div>

    <!-- í•˜ë‹¨ ì»¨íŠ¸ë¡¤: ì„ íƒ ì¢Œí‘œ, ë³µì‚¬, ì €ì¥(ì›¹í›… POST) -->
    <div class="controls">
      <div class="info">
        <div>
          <div><strong>ì„ íƒ ì¢Œí‘œ</strong></div>
          <div id="coords" style="font-family:monospace">-</div>
        </div>

        <div>
          <label for="copyInput"><small>ë³µì‚¬(í´ë¦­ìœ¼ë¡œ ë³µì‚¬)</small></label><br>
          <input id="copyInput" class="copybox" readonly />
        </div>

        <div style="display:flex; flex-direction:column; gap:6px;">
          <button id="copyBtn" title="í´ë¦½ë³´ë“œë¡œ ì¢Œí‘œ ë³µì‚¬">ë³µì‚¬</button>
          <button id="sendBtn" class="secondary" title="ì›¹í›…ì´ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ì „ì†¡">ì €ì¥(ì „ì†¡)</button>
        </div>
      </div>
    </div>

    <p class="note">ì‚¬ìš©ë²•: Notionì˜ 'ì¢Œí‘œì„ íƒ' ë§í¬ë¥¼ í´ë¦­í•˜ë©´ ì´ í˜ì´ì§€ê°€ ì—´ë¦½ë‹ˆë‹¤. ì£¼ì†Œê°€ ì „ë‹¬ë˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ ì¤‘ì•™(ì„œìš¸)ì´ ë¡œë“œë©ë‹ˆë‹¤. ì„ íƒ í›„ ë³µì‚¬í•˜ê±°ë‚˜ ì €ì¥í•˜ì„¸ìš”.</p>
  </div>

  <!-- ì¹´ì¹´ì˜¤ë§µ JS SDK: 'libraries=services' í¬í•¨(ì¢Œí‘œ ë³€í™˜/ì£¼ì†Œ ê²€ìƒ‰ ë“±) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=4010951d8779c420a474f095fd26c0a6&libraries=services"></script>

  <script>
  (function(){
    // ========== ì„¤ì • (ë³€ê²½ ê¸ˆì§€ í•„ìš” ì—†ìŒ) ==========
    // URL íŒŒë¼ë¯¸í„°ë¡œ ë‹¤ìŒì„ ë°›ìŠµë‹ˆë‹¤:
    //  - address=<ì£¼ì†Œ ë¬¸ìì—´>  (url-encoded)
    //  - id=<Notion Page ID or item id>  (ì„ íƒ)
    //  - webhook=<webhook URL>  (ì„ íƒ) -- POST ë°›ëŠ” ì„œë²„(Make ë“±)
    //  - level=<map level> (ì„ íƒ, ê¸°ë³¸ 3)
    // ================================================

    const params = new URLSearchParams(location.search);
    const address = params.get('address') ? decodeURIComponent(params.get('address')) : null;
    const notionName = params.get('name') || null;
    const webhookUrl = params.get('webhook') || null;
    const requestedLevel = parseInt(params.get('level')) || 3; // ê¶Œì¥ 2~3

    // DOM
    const mapDiv = document.getElementById('map');
    const coordsEl = document.getElementById('coords');
    const copyInput = document.getElementById('copyInput');
    const copyBtn = document.getElementById('copyBtn');
    const sendBtn = document.getElementById('sendBtn');

    // ê¸°ë³¸ ì¤‘ì‹¬(ì„œìš¸ ì¤‘ê°„) â€” address ì—†ì„ ë•Œ ì‚¬ìš©
    const DEFAULT_CENTER = new kakao.maps.LatLng(37.566536, 126.977966);

    // ì§€ë„ ì˜µì…˜
    const mapOptions = { center: DEFAULT_CENTER, level: Math.max(1, Math.min(8, requestedLevel)), draggable: true };
    const map = new kakao.maps.Map(mapDiv, mapOptions);

    // ë§ˆì»¤(ì„ íƒìš©)
    const marker = new kakao.maps.Marker({ clickable: true });
    marker.setMap(map);

    // ì§€ì˜¤ì½”ë”(ì£¼ì†Œ->ì¢Œí‘œ)
    const geocoder = new kakao.maps.services.Geocoder();

    // ì¢Œí‘œ ì—…ë°ì´íŠ¸ helper
    function setCoords(lat, lng) {
      const latf = Number(lat).toFixed(7);
      const lngf = Number(lng).toFixed(7);
      coordsEl.textContent = `${latf}, ${lngf}`;
      copyInput.value = `${latf},${lngf}`;
      marker.setPosition(new kakao.maps.LatLng(lat, lng));
      // center the map on selection (keep requested level)
      map.setCenter(new kakao.maps.LatLng(lat, lng));
      map.setLevel(Math.max(1, Math.min(8, requestedLevel)));
    }

    // 1) ì „ë‹¬ëœ ì£¼ì†Œê°€ ìˆìœ¼ë©´ geocode -> center, marker
    if (address) {
      // ì£¼ì†Œ ë””ìŠ¤í”Œë ˆì´ëŠ” ë¸Œë¼ìš°ì € ì½˜ì†”ì— ë‚¨ê¹€ (UIì— ì•ˆ ë³´ëƒ„)
      console.log('ì£¼ì†Œ íŒŒë¼ë¯¸í„°:', address);

      geocoder.addressSearch(address, function(result, status) {
        if (status === kakao.maps.services.Status.OK && result && result[0]) {
          const y = parseFloat(result[0].y);
          const x = parseFloat(result[0].x);
          setCoords(y, x);
        } else {
          console.warn('ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨:', status);
          // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì¤‘ì‹¬ ìœ ì§€
          map.setCenter(DEFAULT_CENTER);
        }
      });
    } else {
      // ì£¼ì†Œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì¤‘ì‹¬ìœ¼ë¡œ ì„¸íŒ…
      map.setCenter(DEFAULT_CENTER);
    }

    // 2) ì§€ë„ í´ë¦­ ì‹œ ì¢Œí‘œ ì„ íƒ
    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
      const latlng = mouseEvent.latLng;
      const lat = latlng.getLat();
      const lng = latlng.getLng();
      setCoords(lat, lng);
    });

    // 3) ë³µì‚¬ ë²„íŠ¼: í´ë¦½ë³´ë“œì— 'lat,lng' ë³µì‚¬
    copyBtn.addEventListener('click', async () => {
      const txt = copyInput.value;
      if (!txt) { alert('ë¨¼ì € ì¢Œí‘œë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
      try {
        await navigator.clipboard.writeText(txt);
        copyBtn.textContent = 'ë³µì‚¬ë¨ âœ“';
        setTimeout(()=>copyBtn.textContent='ë³µì‚¬', 1200);
      } catch (e) {
        // fallback
        copyInput.select();
        document.execCommand('copy');
        copyBtn.textContent = 'ë³µì‚¬ë¨ âœ“';
        setTimeout(()=>copyBtn.textContent='ë³µì‚¬', 1200);
      }
    });

    // 4) ì €ì¥(ì „ì†¡) ë²„íŠ¼: ì›¹í›…ì´ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ JSON POST
    sendBtn.addEventListener('click', async () => {
      const val = copyInput.value;
      if (!val) { alert('ì¢Œí‘œë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }
      const [lat, lng] = val.split(',');

      // ë§Œì•½ webhook íŒŒë¼ë¯¸í„°ê°€ ì£¼ì–´ì§€ë©´ POST
      if (webhookUrl) {
        try {
          const payload = {
            id: notionId || null,
            lat: lat.trim(),
            lng: lng.trim(),
            source: location.href,
            ts: new Date().toISOString()
          };
          const res = await fetch(webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify(payload)
          });
          if (res.ok) {
            alert('ì¢Œí‘œê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
          } else {
            const txt = await res.text().catch(()=>res.statusText);
            alert('ì „ì†¡ ì‹¤íŒ¨: ' + (txt || res.status));
          }
        } catch (err) {
          console.error(err);
          alert('ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì½˜ì†” í™•ì¸)');
        }
      } else {
        // webhookì´ ì—†ìœ¼ë©´ í´ë¦½ë³´ë“œë¡œ ë³µì‚¬ë˜ì—ˆìŒì„ ì•Œë¦¼
        try { await navigator.clipboard.writeText(val); } catch (e){ /* ignore */ }
        alert('ì›¹í›…ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¢Œí‘œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    });

    // 5) Optional: openerê°€ ìˆì„ ê²½ìš°(íŒì—…ìœ¼ë¡œ ì—´ì—ˆë‹¤ë©´) ì„ íƒëœ ì¢Œí‘œë¥¼ openerë¡œ postMessageë¡œ ë³´ë‚¼ ìˆ˜ ìˆê²Œ í•¨
    //    openerê°€ ì¡´ì¬í•˜ê³  ë©”ì‹œì§€ ìˆ˜ì‹  êµ¬í˜„ì´ ë˜ì–´ ìˆìœ¼ë©´ ìë™ ì „ë‹¬í•˜ë„ë¡ í•  ìˆ˜ ìˆìŒ.
    window.addEventListener('beforeunload', function(){
      if (window.opener && copyInput.value) {
        try {
          window.opener.postMessage({ type:'coordsSelected', coords: copyInput.value, id: notionId || null }, '*');
        } catch(e){}
      }
    });

    // UX: ì§€ë„ì˜ zoomì´ë‚˜ center ê°•ì œ: ê¶Œì¥ ë ˆë²¨ 2~3ìœ¼ë¡œ ê³ ì •í•˜ë ¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
    // map.setLevel(3); // ê°•ì œ ê³ ì •(ì›í•˜ë©´ ì‚¬ìš©)
  })();
  </script>
</body>
</html>
