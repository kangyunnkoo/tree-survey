<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>수목 위치도</title>
  <style>
    #map { width: 100%; height: 100vh; }
  </style>
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=4010951d8779c420a474f095fd26c0a6"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div id="map"></div>
  <script>
    // URL 파라미터 파싱
    const params = new URLSearchParams(window.location.search);
    const csvUrl = params.get("csv");  // 예: trees.csv
    const centerLat = parseFloat(params.get("centerLat")) || 37.5665; // 기본: 서울시청
    const centerLng = parseFloat(params.get("centerLng")) || 126.9780;

    // 지도 생성 (중심좌표를 파라미터로 반영)
    const mapContainer = document.getElementById("map");
    const mapOption = {
      center: new kakao.maps.LatLng(centerLat, centerLng),
      level: 5
    };
    const map = new kakao.maps.Map(mapContainer, mapOption);

    // Canvas로 번호 마커 이미지 생성 함수
    function createNumberMarker(num) {
      const size = 18;
      const canvas = document.createElement("canvas");
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext("2d");

      // 원형 배경
      ctx.fillStyle = "#1976d2";
      ctx.beginPath();
      ctx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
      ctx.fill();

      // 숫자
      ctx.fillStyle = "#fff";
      ctx.font = "bold 10px Arial";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(num, size/2, size/2);

      return new kakao.maps.MarkerImage(
        canvas.toDataURL(),
        new kakao.maps.Size(size, size)
      );
    }

    // CSV 파일 로드
    // async function loadCSV() {
    //   const res = await fetch(csvUrl);
    //   const text = await res.text();
    //   const rows = text.trim().split("\n").map(r => r.split(","));
    //   return rows.slice(1); // 첫 줄은 헤더 제거
    // }

    async function loadCSV() {
      const res = await fetch(csvUrl);
      const text = await res.text();
    
      const parsed = Papa.parse(text, {
        header: true,        // 첫 줄을 헤더로 사용
        skipEmptyLines: true
      });
    
      // 숫자 컬럼은 숫자로 변환
      return parsed.data.map(row => ({
        no: row["no"],
        name: row["name"],
        status: row["status"],
        lat: parseFloat(row["lat"]),
        lng: parseFloat(row["lng"])
      }));
    }
    
    // 마커 표시
    async function drawMarkers() {
      const data = await loadCSV();
      let currentInfoWindow = null; // 현재 열린 infowindow 추적
      data.forEach((row, i) => {
        const no = row[0] || `수목${i+1}`;
        const name = row[1] || '';
        const status = row[2] || '';
        const lat = parseFloat(row[3]); // CSV 첫 번째 컬럼 = 위도
        const lng = parseFloat(row[4]); // CSV 두 번째 컬럼 = 경도

        const marker = new kakao.maps.Marker({
          position: new kakao.maps.LatLng(lat, lng),
          image: createNumberMarker(no),
          map: map
        });

        const infowindow = new kakao.maps.InfoWindow({
          content: `<div style="padding:5px;">${name}-${status}</div>`
        });

        kakao.maps.event.addListener(marker, "click", () => {
            if (currentInfoWindow === infowindow) {
              // 이미 열려있던 창 → 닫기
              infowindow.close();
              currentInfoWindow = null;
            } else {
              // 다른 창이 열려있으면 닫기
              if (currentInfoWindow) {
                currentInfoWindow.close();
              }
              // 새 창 열기
              infowindow.open(map, marker);
              currentInfoWindow = infowindow;
            }
        });
      });
    }

    drawMarkers();
  </script>
</body>
</html>
