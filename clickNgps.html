<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ìˆ˜ëª© ìœ„ì¹˜ ì„ íƒ</title>
  <style>
    #map { width:100%; height:85vh; }
    #panel {
      height: 15vh;
      padding: 10px;
      font-size: 14px;
      background: #f4f4f4;
      border-top: 1px solid #ccc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #coords { flex: 1; }
    #saveBtn {
      padding: 8px 14px;
      font-size: 14px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #saveBtn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
  </style>
  <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c869edfd3e17871184f35a648382891b"></script>
</head>
<body>

  <div id="map" style="width:100%;height:400px;"></div>
  <div id="panel">
    <div id="coords">ì§€ë„ì—ì„œ ìˆ˜ëª© ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.</div>
    <button id="saveBtn" disabled>ì €ì¥</button>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const urlLat = parseFloat(params.get("lat"));
    const urlLng = parseFloat(params.get("lng"));
    const notionId = params.get("id");
    alert("1");
    const map = new kakao.maps.Map(document.getElementById('map'), {
      center: new kakao.maps.LatLng(37.5665, 126.9780),
      level: 3
    });
    alert("2");
    let marker = null;
    let selectedCoords = null;
    const coordsBox = document.getElementById("coords");
    const saveBtn = document.getElementById("saveBtn");

    // URL ì¢Œí‘œ ìš°ì„  â†’ ì—†ìœ¼ë©´ í˜„ì¬ ìœ„ì¹˜
    if (!isNaN(urlLat) && !isNaN(urlLng)) {
      map.setCenter(new kakao.maps.LatLng(urlLat, urlLng));
    } else if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const locPosition = new kakao.maps.LatLng(lat, lng);
        map.setCenter(locPosition);
        new kakao.maps.Marker({ map: map, position: locPosition });
      });
    }

    // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸
    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
      const latlng = mouseEvent.latLng;

      if (marker) marker.setMap(null);
      marker = new kakao.maps.Marker({
        position: latlng,
        map: map
      });

      selectedCoords = { lat: latlng.getLat(), lng: latlng.getLng() };
      coordsBox.textContent = `ì„ íƒëœ ì¢Œí‘œ â†’ ìœ„ë„: ${selectedCoords.lat.toFixed(6)}, ê²½ë„: ${selectedCoords.lng.toFixed(6)}`;
      saveBtn.disabled = false;
    });

    // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    saveBtn.addEventListener("click", function() {
      if (!selectedCoords) return;

      fetch("https://hook.integromat.com/YOUR_WEBHOOK_ID", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          notionId: notionId,
          latitude: selectedCoords.lat,
          longitude: selectedCoords.lng
        })
      }).then(() => {
        alert("ì¢Œí‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
        // ğŸ“Œ ë…¸ì…˜ í˜ì´ì§€ë¡œ ìë™ ì´ë™
        window.location.href = `https://www.notion.so/${notionId}`;
      }).catch(err => console.error(err));
    });
  </script>
</body>
</html>
