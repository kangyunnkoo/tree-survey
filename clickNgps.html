<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>수목 위치 선택</title>
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:85%; }
    #panel {
      height:15%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px;
      background:#f4f4f4;
      border-top:1px solid #ccc;
      font-size:14px;
    }
    #coords { flex:1; }
    #saveBtn {
      padding:8px 14px;
      font-size:14px;
      background:#007bff;
      color:white;
      border:none;
      border-radius:4px;
      cursor:pointer;
    }
    #saveBtn:disabled {
      background:#aaa;
      cursor:not-allowed;
    }
  </style>
  <!-- 카카오맵 JS SDK -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=4010951d8779c420a474f095fd26c0a6"></script>
</head>
<body>
  <div id="map"></div>
  <div id="panel">
    <div id="coords">지도에서 수목 위치를 클릭하세요.</div>
    <button id="saveBtn" disabled>저장</button>
  </div>

  <script>
    window.onload = function() {
      const params = new URLSearchParams(window.location.search);
      const urlLat = parseFloat(params.get("lat"));
      const urlLng = parseFloat(params.get("lng"));
      const notionId = params.get("id");

      const mapContainer = document.getElementById('map');

      // 기본 지도 옵션 (서울 시청)
      const mapOptions = {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 3
      };

      const map = new kakao.maps.Map(mapContainer, mapOptions);
      let marker = null;
      let selectedCoords = null;
      const coordsBox = document.getElementById("coords");
      const saveBtn = document.getElementById("saveBtn");

      // URL 좌표 우선
      if (!isNaN(urlLat) && !isNaN(urlLng)) {
        map.setCenter(new kakao.maps.LatLng(urlLat, urlLng));
      }
      // URL 없으면 현재 위치
      else if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const locPosition = new kakao.maps.LatLng(lat, lng);
          map.setCenter(locPosition);

          // 현재 위치 마커
          new kakao.maps.Marker({ map: map, position: locPosition });
        }, function(error) {
          console.warn("현재 위치를 가져올 수 없습니다.", error);
        });
      }

      // 지도 클릭 이벤트
      kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        const latlng = mouseEvent.latLng;

        // 이전 마커 제거
        if (marker) marker.setMap(null);

        marker = new kakao.maps.Marker({
          position: latlng,
          map: map
        });

        selectedCoords = { lat: latlng.getLat(), lng: latlng.getLng() };
        coordsBox.textContent = `선택된 좌표 → 위도: ${selectedCoords.lat.toFixed(6)}, 경도: ${selectedCoords.lng.toFixed(6)}`;
        saveBtn.disabled = false;
      });

      // 저장 버튼 클릭 이벤트
      saveBtn.addEventListener("click", function() {
        if (!selectedCoords) return;

        fetch("https://hook.integromat.com/YOUR_WEBHOOK_ID", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            notionId: notionId,
            latitude: selectedCoords.lat,
            longitude: selectedCoords.lng
          })
        }).then(() => {
          alert("좌표가 저장되었습니다!");
          // 노션 페이지로 자동 리다이렉트
          window.location.href = `https://www.notion.so/${notionId}`;
        }).catch(err => console.error(err));
      });
    }
  </script>
</body>
</html>
